var $j = jQuery;



$j(window).bind("load",function() {

	if( tekRepairStatusUris.prefilled ) {
		
		var sro1 = $j('#sro1').val();
		var sro2 = $j('#sro2').val();
		var sro3 = $j('#sro3').val();
		var zip = $j('#zip').val();
		
		queryAjax(sro1, sro2, sro3, zip);
		
		//this probably isn't necessary with the current layout, but is useful on long pages
		document.location.hash = "#repairstatus";
		goToAnchor();
		
	} //end if( tekRepairStatusUris.prefilled )

	$j('button.positive').click(function () {
	
		var sro1 = $j('#sro1').val();
		var sro2 = $j('#sro2').val();
		var sro3 = $j('#sro3').val();
		var zip = $j('#zip').val();
	
	
		if ( !$j('#sro1').val() || !$j('#sro2').val() || !$j('#sro3').val() || !$j('#zip').val() ) {
		
			$j('form.status-front').addClass('errorForm');
	
		}
		else {
	
			$j('form.status-front').removeClass('errorForm');
			queryAjax(sro1, sro2, sro3, zip);
		
		} //end if ( !$j('#sro1').val() || !$j('#sro2').val() || !$j('#sro3').val() || !$j('#zip').val() )
	
	}); //end $j('button.positive').click(function ()
	
}); //end $j(window).bind("load",function()




//utility function to move to next field after reaching max length in a previous field; called onkeyup in form fields generated by shortcode
function checkLen(x, y) {

    if (y.length == x.maxLength) {
    
        var next = x.tabIndex;
        if (next < document.getElementById('status-front').length) {
        
            document.getElementById('status-front').elements[next].focus();
        
        }	//end if (next < document.getElementById('status-front').length)
    
    }	//end if (y.length == x.maxLength)

} //end function checkLen(x, y)



//kinda lazily called by link generated by shortcode. good thing this is relatively unique...
function showExampleSRO() {

	$j('#whats-sro').toggle();

} //end function showExampleSRO()



//main function performs jquery ajax call to included file ajaxp.php, which uses ajaxhelper.php functions to query db specified in admin. (structured this way in anticipation of replacing the helper with a class accessing the sro api in development)
function queryAjax(sro1, sro2, sro3, zip) {

	var sro_zip = 'Invoice #: ' + sro1 + '-' + sro2 + '-' + sro3 + '<br />' + 'Billing Zip Code: ' + zip;
	var img_base_path = tekRepairStatusUris.themeUri + '/images/step';
	var repair_status = new Array('Created', 'In Progress', 'Testing', 'On Hold', 'Done', 'Ready for Pickup');
	
	$j.ajax({
	
		type: 'GET',
		dataType: 'jsonp',
		url: tekRepairStatusUris.pluginUri + '/ajaxp.php/?sro=' + sro1 + sro2 + sro3 + '&zip=' + zip,
		beforeSend: function() {
		
			$j('#status-content').children('p').add('form.status-front').hide();
			var $loader = '<div id="loader" ><img src="' + tekRepairStatusUris.themeUri + '/images/ajax-loader.gif" /></div>';
			$j('#status-content').append($loader);
			
		}, //end beforeSend: function()
		
		success: function (msg) {
		
			if (msg == false || msg == null || msg.typeOf == 'string' ) {
			
				$j('#loader').hide();
				$j('#status-title').find('strong').html('Login Failed');
				$j('#fail-msg').show();
				return;
				
			} //end if (msg == false || msg == null || msg.typeOf == 'string' )
			var product_name = 'Product: ' + msg.product;
			$j('#status-title').find('strong').html('Repair Status');
			$j('form.status-front').hide();
			$j('#loader').hide();
			$j('#customer-info').show();
			$j('.customer-info').show();
			$j('#customer-info div').html('Name: ' + msg.name + '<br/>' + sro_zip);
			console.log(sro_zip);
			var product_name = '<h3>Product</h3><div>' + msg.product + '</div>';
			console.log(product_name);
			$j('#product-info').html(product_name);
			var result = msg.status;
			
			switch(result) {
			
				case 'Created':
					break;
				case 'In Progress':
					break;
				case 'INTAKE':
					result = 'In Progress';
					break;
				case 'REPAIR':
					result = 'In Progress';
					break;
				case 'hold\/internal':
					result = 'In Progress';
					break;
				case 'hold\/complete payment':
					result = 'On Hold';
					break;
				case 'hold\/info':
					result = 'On Hold';
					break;
				case 'hold\/payment':
					result = 'On Hold';
					break;
				case 'hold\/no Email':
					result = 'On Hold';
					break;
				case 'hold\/recovery':
					result = 'On Hold';
					break;
				case 'hold\/discuss':
					result = 'On Hold';
					break;
				case 'hold\/spill':
					result = 'On Hold';
					break;
				case 'hold\/pw':
					result = 'On Hold';
					break;
				case 'WAIT':
					result = 'On Hold';
					break;
				case 'Testing':
					break;
				case 'Service Complete TOAC':
					result = 'Ready for Pickup';
					break;
				case 'Service Complete':
					result = 'Ready for Pickup';
					break;
				case 'Done':
					result = 'Done';
					break;
				default:
					result = 'On Hold';
					
			} //end switch(result)
			
			var result_index = $j.inArray(result, repair_status);
			$j('#status-content').children('img').attr('src', img_base_path + result_index + '.svg');
			$j('#status-content').children('img').attr('alt', result);
			$j('#status-content').children('img').show();
			var detail_cmt = $j('ul.repair-details').find('li');
			$j(detail_cmt[result_index]).show();
			
		} //end success: function (msg)
		
	}); //end $j.ajax

}// end function queryAjax(sro1, sro2, sro3, zip)